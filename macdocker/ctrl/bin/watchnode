#!/bin/bash
#
# businessUnit/repo/serveruid/servername=ID
# do an update of groups/members on a timed interval
# set as sleepfor var in seconds to wait between checks
#
sleepfor=31


curlcmd="curl -s http://keystore:2379/v2/keys"
repodir="/ctrl/repo"
repodata="$repodir/data"
jobpid=$$

countdown() {
  secs=$1
  while [ $secs -gt 0 ]
  do
    sleep 1 &
    #echo -en "\r Next run in: $secs"
    secs=$(( $secs - 1 ))
    wait
  done
  echo
}

while true ; do 

#checkin="$(etcdctl get hello &>/dev/null)"
#if [ "$checkin" == 'sleep' ] ; then
#    continue
#else

    GROUPLIST=()

#jobstart=$(date -u +%s)

    GETGROUPS="$($curlcmd/groups/)"
    GROUPLIST=($(jq -r '.node.nodes[]?.key' <<< "${GETGROUPS}"))
    if [ ${#GROUPLIST[@]} -lt 1 ] ; then
        echo "No Groups found"
    else
        for MYGROUP in "${GROUPLIST[@]}" ; do
            REPO=$(cut -d '/' -f 3 <<< "${MYGROUP}")
            if [ ! -d $repodata/$REPO ] ; then
                echo "Group setup needed for $REPO, rebuilding group mappings . . . "
                /ctrl/bin/updategroups
            fi
        done

        #REPOKEYIN="$(echo ${MYGROUP} | cut -d '/' -f 3)"
        #echo "$REPO ID $REPOKEYIN

    jobstart=$(date -u +%s)

    /usr/bin/node /ctrl/vsec/openvsec.js
 
    jobstop=$(date -u +%s)
    (( jobtime = jobstop - jobstart ))
    jobclose=$(date)
     echo "generated in $(($jobtime/3600)):$(($jobtime%3600/60)):$(($jobtime%60))"     
    echo " "
    fi
    countdown $sleepfor

done
